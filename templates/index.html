<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Motor Digital Twin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2rem; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 1.2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.04); max-width: 900px; }
    .row { display: flex; gap: 1rem; margin-top: 0.6rem; flex-wrap: wrap; }
    .metric { flex: 1; min-width: 220px; background: #f5f5f5; border-radius: 10px; padding: 0.8rem; }
    .label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: .06em; }
    .value { font-size: 28px; margin-top: 0.2rem; }
    .ok { color: #1a7f37; }
    .warn { color: #b51d09; font-weight: 600; }
    .controls { margin: 1rem 0; display: flex; gap: .6rem; flex-wrap: wrap; }
    button { padding: .5rem .8rem; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    button:active { transform: translateY(1px); }
    .btn-stop { background: #ffeaea; border-color: #ffb3b3; }
    .btn-start { background: #eaffea; border-color: #b3ffb3; }
    .status { margin-top: .4rem; font-weight: 600; }
  </style>

  <!-- Socket.IO client with fallback (in case one CDN is blocked) -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    if (typeof io === 'undefined') {
      var s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js';
      document.head.appendChild(s);
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>
  <h2>Motor Digital Twin</h2>

  <div class="card">
    <div class="row">
      <div class="metric">
        <div class="label">RPM</div>
        <div id="rpm" class="value">0</div>
      </div>
      <div class="metric">
        <div class="label">Temperature</div>
        <div id="temp" class="value">0 °C</div>
      </div>
      <div class="metric">
        <div class="label">Motor Status</div>
        <div id="running" class="value ok">Running</div>
        <div id="alert" class="status">Waiting for data…</div>
      </div>
    </div>

    <div class="controls">
      <button id="btn-pause">Pause Chart</button>
      <button id="btn-resume">Resume Chart</button>
      <button id="btn-clear">Clear Chart</button>
      <button id="btn-stop" class="btn-stop">Stop Motor</button>
      <button id="btn-start" class="btn-start">Start Motor</button>
    </div>

    <canvas id="trend" height="200"></canvas>
  </div>

  <script>
    window.addEventListener('load', () => {
      if (typeof io === 'undefined') {
        alert('Socket.IO client failed to load. Check network/AdBlock and reload.');
        return;
      }

      const socket = io();
      console.log('[WS] Attempting to connect…');

      const MAX_POINTS = 60;
      let chartPaused = false;

      const trendChart = new Chart(document.getElementById('trend'), {
        type: 'line',
        data: { labels: [], datasets: [
          { label: 'Temperature (°C)', data: [], tension: 0.25 },
          { label: 'RPM', data: [], yAxisID: 'y1', tension: 0.25 }
        ]},
        options: {
          responsive: true, animation: false,
          scales: { y:{ title:{ text:'°C', display:true } }, y1:{ position:'right', title:{ text:'RPM', display:true } } },
          plugins: { legend: { display: true } }
        }
      });

      // Chart controls
      document.getElementById('btn-pause').onclick  = () => chartPaused = true;
      document.getElementById('btn-resume').onclick = () => chartPaused = false;
      document.getElementById('btn-clear').onclick  = () => {
        trendChart.data.labels = [];
        trendChart.data.datasets[0].data = [];
        trendChart.data.datasets[1].data = [];
        trendChart.update();
      };

      // Motor control
      document.getElementById('btn-stop').onclick = () => socket.emit("motor_command", { action: "stop" });
      document.getElementById('btn-start').onclick = () => socket.emit("motor_command", { action: "start" });

      socket.on('connect', () => console.log('[WS] Dashboard connected'));
      socket.on('disconnect', () => console.log('[WS] Dashboard disconnected'));

      socket.on('update_dashboard', (data) => {
        // Metrics
        document.getElementById('rpm').textContent  = data.rpm ?? 0;
        document.getElementById('temp').textContent = (data.temperature ?? 0) + ' °C';

        // Overheat message
        const alertEl = document.getElementById('alert');
        if ((data.temperature ?? 0) > 90) {
          alertEl.textContent = '⚠️ Overheating!';
          alertEl.className = 'status warn';
        } else {
          alertEl.textContent = '✓ Normal';
          alertEl.className = 'status ok';
        }

        // Running status
        const runningEl = document.getElementById('running');
        if (data.running === false) {
          runningEl.textContent = 'Stopped';
          runningEl.className = 'value warn';
        } else {
          runningEl.textContent = 'Running';
          runningEl.className = 'value ok';
        }

        // Chart
        if (!chartPaused && typeof data.temperature === 'number' && typeof data.rpm === 'number') {
          const ts = new Date().toLocaleTimeString();
          trendChart.data.labels.push(ts);
          trendChart.data.datasets[0].data.push(data.temperature);
          trendChart.data.datasets[1].data.push(data.rpm);
          if (trendChart.data.labels.length > MAX_POINTS) {
            trendChart.data.labels.shift();
            trendChart.data.datasets[0].data.shift();
            trendChart.data.datasets[1].data.shift();
          }
          trendChart.update();
        }
      });
    });
  </script>
</body>
</html>

